rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: Check if user owns this resource
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Helper function: Validate user profile data
    function isValidUserProfile() {
      let data = request.resource.data;
      return data.displayName is string &&
             data.displayName.size() >= 1 &&
             data.displayName.size() <= 100 &&
             data.bio is string &&
             data.bio.size() <= 500 &&
             data.profilePicUrl is string;
    }
    
    // Helper function: Validate scheduled meeting data
    function isValidScheduledMeeting() {
      let data = request.resource.data;
      return data.title is string &&
             data.title.size() >= 1 &&
             data.title.size() <= 200 &&
             data.description is string &&
             data.description.size() <= 1000 &&
             data.scheduledAt is timestamp &&
             data.durationMinutes is number &&
             data.durationMinutes >= 5 &&
             data.durationMinutes <= 480;
    }
    
    // Helper function: Validate meeting history data
    function isValidMeetingHistory() {
      let data = request.resource.data;
      return data.title is string &&
             data.startedAt is timestamp &&
             data.endedAt is timestamp &&
             data.participantsCount is number &&
             data.participantsCount >= 1;
    }
    
    // ========== USER PROFILE ==========
    match /users/{uid} {
      // Read: Only owner can read their profile
      allow read: if isOwner(uid);
      
      // Create: Only owner can create their profile
      allow create: if isOwner(uid);
      
      // Update: Only owner can update their profile
      allow update: if isOwner(uid);
      
      // Delete: Users cannot delete their profile (admin only)
      allow delete: if false;
      
      // ========== SCHEDULED MEETINGS SUBCOLLECTION ==========
      match /scheduledMeetings/{meetingId} {
        // Read: Only owner can read their scheduled meetings
        allow read: if isOwner(uid);
        
        // Create: Owner can create meetings
        allow create: if isOwner(uid);
        
        // Update: Owner can update their meetings
        allow update: if isOwner(uid);
        
        // Delete: Owner can delete their meetings
        allow delete: if isOwner(uid);
      }
      
      // ========== MEETING HISTORY SUBCOLLECTION ==========
      match /meetingHistory/{meetingId} {
        // Read: Only owner can read their history
        allow read: if isOwner(uid);
        
        // Create: Only owner can add to their history
        allow create: if isOwner(uid);
        
        // Update: History should not be updated
        allow update: if false;
        
        // Delete: Owner can delete old history entries
        allow delete: if isOwner(uid);
      }
    }
    
    // ========== INSTANT MEETINGS COLLECTION ==========
    match /meetings/{meetingId} {
      // Read: Any authenticated user can read meeting details (for validation)
      allow read: if isAuthenticated();
      
      // Create: Any authenticated user can create a meeting
      allow create: if isAuthenticated() && 
                      request.resource.data.creatorUid == request.auth.uid;
      
      // Update: Only meeting creator can update (add participants, etc.)
      //         OR any authenticated user can add themselves to participants array
      allow update: if isAuthenticated() && 
                      (resource.data.creatorUid == request.auth.uid ||
                       // Allow updating participants array only
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participants']));
      
      // Delete: Only creator can delete
      allow delete: if isAuthenticated() && resource.data.creatorUid == request.auth.uid;
    }
    
    // ========== DEFAULT DENY ALL ==========
    // Any path not explicitly matched above is denied
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
